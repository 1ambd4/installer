<Project>
  <UsingTask AssemblyFile="$(SdkArchiveDiffTasksAssembly)" TaskName="GetValidArchiveItems" />
  <UsingTask AssemblyFile="$(SdkArchiveDiffTasksAssembly)" TaskName="GetClosestOfficialSdk" />
  <UsingTask AssemblyFile="$(SdkArchiveDiffTasksAssembly)" TaskName="FindArchiveDiffs" />

  <Target Name="ReportSdkArchiveDiffs"
          AfterTargets="Build"
          DependsOnTargets="DetermineSourceBuiltSdkVersion"
          Condition="'$(ShortStack)' != 'true'" >

      <GetValidArchiveItems ArchiveItems="@(SdkTarballItem)"
                            ArchiveName="dotnet-sdk">
        <Output TaskParameter="ValidArchiveItems"
                ItemName="_BuiltSdkArchivePath"/>
      </GetValidArchiveItems>

      <!-- There should only be 1 SDK archive -->
      <Error Text="Multiple valid dotnet-sdk archives found."
             Condition="'@(_BuiltSdkArchivePath->Count())' != '1'" />

      <GetClosestOfficialSdk BuiltArchivePath="@(_BuiltSdkArchivePath)"
                             Condition="'@(_BuiltSdkArchivePath)' != ''">
        <Output TaskParameter="ClosestOfficialArchivePath"
                PropertyName="_ClosestOfficialSdkPath" />
      </GetClosestOfficialSdk>

      <FindArchiveDiffs BaselineArchive="@(_BuiltSdkArchivePath)"
                        TestArchive="$(_ClosestOfficialSdkPath)"
                        Condition="'@(_BuiltSdkArchivePath)' != '' AND '$(_ClosestOfficialSdkPath)' != ''">
        <Output TaskParameter="ContentDifferences"
                ItemName="_ContentDifferences" />
      </FindArchiveDiffs>

      <Message Text="Difference in sdk archive: %(_ContentDifferences.Kind): %(_ContentDifferences.Identity)"
               Importance="High"
               Condition="'%(_ContentDifferences.Identity)' != '' AND '%(_ContentDifferences.Kind)' != 'Unchanged'"/>

      <Delete Files="$(_ClosestOfficialSdkPath)"
              Condition="'$(_ClosestOfficialSdkPath)' == ''"/>

  </Target>

</Project>
