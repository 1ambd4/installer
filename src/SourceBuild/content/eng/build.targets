<Project>
  <UsingTask AssemblyFile="$(SdkArchiveDiffTasksAssembly)" TaskName="FindArchiveDiffs" />
  <UsingTask AssemblyFile="$(SdkArchiveDiffTasksAssembly)" TaskName="GetClosestOfficialSdk" />
  <UsingTask AssemblyFile="$(SdkArchiveDiffTasksAssembly)" TaskName="GetSingleArchiveItem" />

  <Target Name="ReportSdkArchiveDiffs"
          AfterTargets="Build"
          DependsOnTargets="DetermineSourceBuiltSdkVersion" >

      <GetSingleArchiveItem SdkArchiveItems="@(SdkTarballItem)">
        <Output TaskParameter="BestSdkArchiveItem" PropertyName="_BuiltSdkArchivePath"/>
      </GetSingleArchiveItem>

      <GetClosestOfficialSdk BuiltSdkPath="$(_BuiltSdkArchivePath)" Condition="'$(_BuiltSdkArchivePath)' != ''">
        <Output TaskParameter="ClosestOfficialSdkPath" PropertyName="_ClosestOfficialSdkPath" />
      </GetClosestOfficialSdk>

      <Message Text="Failed to find closest official SDK archive." Importance="High" Condition="'$(_BuiltSdkArchivePath)' != '' AND '$(_ClosestOfficialSdkPath)' == ''" />

      <FindArchiveDiffs BaselineArchive="$(_BuiltSdkArchivePath)" TestArchive="$(_ClosestOfficialSdkPath)" Condition="'$(_BuiltSdkArchivePath)' != '' AND '$(_ClosestOfficialSdkPath)' != ''">
        <Output TaskParameter="ContentDifferences" ItemName="_ContextDifferences" />
      </FindArchiveDiffs>

      <Message Text="Difference in sdk archive: %(_ContextDifferences.Kind): %(_ContextDifferences.Identity)" Importance="High" Condition="'%(_ContextDifferences.Identity)' != '' AND '%(_ContextDifferences.Kind)' != 'Unchanged'"/>
      <Delete Files="$(_ClosestOfficialSdkPath)" Condition="'$(_ClosestOfficialSdkPath)' == ''"/>

  </Target>

</Project>
