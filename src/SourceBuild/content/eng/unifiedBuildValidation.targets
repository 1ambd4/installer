<Project>

  <PropertyGroup>
    <UnifiedBuildValidationTestsDir>$([MSBuild]::NormalizeDirectory('$(RepoRoot)', 'test', 'Microsoft.DotNet.UnifiedBuild.Tests'))</UnifiedBuildValidationTestsDir>
    <UnifiedBuildValidationTestsProject>$([MSBuild]::NormalizeDirectory('$(UnifiedBuildValidationTestsDir)', 'Microsoft.DotNet.UnifiedBuild.Tests'))</UnifiedBuildValidationTestsProject>
  </PropertyGroup>

  <Target Name="RunUnifiedBuildValidation"
          AfterTargets="Build"
          DependsOnTargets="DetermineSourceBuiltSdkVersion">

    <ItemGroup>
      <_UnifiedBuildValidationEnvVar Include="UNIFIED_BUILD_VALIDATION_SDK_TARBALL_PATH" Value="$(SdkTarballPath)" />
      <_UnifiedBuildValidationEnvVar Include="UNIFIED_BUILD_VALIDATION_TARGET_RID" Value="$(TargetRid)" />
      <_UnifiedBuildValidationEnvVar Include="UNIFIED_BUILD_VALIDATION_PORTABLE_RID" Value="$(PortableRid)" />
      <_UnifiedBuildValidationEnvVar Include="UNIFIED_BUILD_VALIDATION_BUILD_VERSION" Value="$(SourceBuiltSdkVersion)" />
    </ItemGroup>

    <PropertyGroup>
      <SdkTarballPath>%(SdkTarballItem.Identity)</SdkTarballPath>
      <_EnvVarRunSettingsPrefix>RunConfiguration.EnvironmentVariables</_EnvVarRunSettingsPrefix>
      <EnvironmentVariableRunSettings>@(_UnifiedBuildValidationEnvVar->'$(RunConfiguration.EnvironmentVariables).%(Identity)=%(Value)')</EnvironmentVariableRunSettings>
    </PropertyGroup>

    <MSBuild Projects="$(UnifiedBuildValidationTestsDir)"
             Targets="Test"
             Properties="Configuration=$(Configuration);VSTestUseMSBuildOutput=false;VSTestLogger=trx;VSTestCLIRunSettings=$(EnvironmentVariableRunSettings)" />

  </Target>

</Project>
